{"version":3,"sources":["api/qrcode/qrcode.controller.js"],"names":["_","require","config","exports","index","req","res","url","host","params","id","QRCode","Canvas","Image","canvas","ctx","getContext","draw","err","qrcode","img","src","toBuffer","drawImage","font","fillText","w","width","h","height","data","getImageData","compositeOperation","globalCompositeOperation","fillStyle","fillRect","stream","pngStream","out","createWriteStream","root","on","chunk","write","console","log","render","toDataURL","gift_get","next","request","debug","hostname","split","shift","options","api","uri","headers","component","json","error","response","body","send","statusCode","message","errmsg","order","gift_qrcode","download","Archiver","zip","fs","pointer","i","giftorders","dir","moment","time","add","format","file","serial","existsSync","append","createReadStream","name","finalize"],"mappings":"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","file":"api/qrcode/qrcode.controller.js","sourcesContent":["'use strict';\n\nvar _ = require('lodash');\nvar config = require('../../config/environment');\n\n// Get list of things\nexports.index = function(req, res) {\n  var url = 'http://'+req.host+'.songni.cc/gift/listen/'+req.params.id;\n  var QRCode = require('qrcode');\n  /*\n  QRCode.toDataURL(url,function(err,src){\n    res.render('qrcode',{src:src});\n  });\n  QRCode.draw('mama', function(error,canvas){\n    res.render('qrcode',{src:canvas.toDataURL()});\n  });*/\n  var Canvas = require('canvas')\n    , Image = Canvas.Image\n    , canvas = new Canvas(600, 600)\n    , ctx = canvas.getContext('2d')\n    ;\n\n  QRCode.draw(url,function(err,qrcode){\n    canvas = new Canvas(600, 600)\n    ctx = canvas.getContext('2d')\n    var img = new Image();\n    img.src=qrcode.toBuffer();\n    ctx.drawImage(img,100,70,400,400);\n    //头像\n    //var avator = new Image();\n    //avator.src = config.root+'/data/avator/maitian.jpg';\n    //ctx.drawImage(avator,260,250,50,50);\n    \n    ctx.font = \"bold 24px 'WenQuanYi Micro Hei'\";\n    ctx.fillText('亲爱的大鼻子', 100, 30);\n\n    ctx.font = \"16px 'WenQuanYi Micro Hei'\";\n    ctx.fillText('微信扫一扫,听Ta对你说', 130, 80);\n\n    ctx.fillText('大鼻子 2015年7月7日', 310, 470);\n    \n    var w = canvas.width;\n    var h = canvas.height;\n    var data = ctx.getImageData(0, 0, w, h);\n    var compositeOperation = ctx.globalCompositeOperation;\n    ctx.globalCompositeOperation = \"destination-over\";\n    ctx.fillStyle = 'white';\n    ctx.fillRect(0,0,w,h);\n\n    var stream = canvas.pngStream();\n    var out = require('fs').createWriteStream(config.root+'/data/qrcode/a.png')\n    stream.on('data', function(chunk){out.write(chunk);});\n    stream.on('end', function(){console.log('saved png');});\n\n    res.render('qrcode',{src:canvas.toDataURL()});\n  });\n};\nexports.gift_get = function(req,res,next){\n  var request = require('request');\n  require('request').debug = true;\n  var hostname = req.host.split('.').shift();\n  var options = {\n    url: config.api.uri+'/gift/order/'+req.params.id,\n    headers: {\n      'X-API-From':'merchant',\n      'X-Component':config.api.component\n    },\n    json:true\n  };\n  request(options, function (error, response, body) {\n    if(error){\n      console.log(error);\n      res.send('系统错误！');\n      return;\n    }\n    if(response.statusCode !== 200){\n      var message = body.errmsg?body.errmsg:'系统错误！';\n      res.send(message);\n      return;\n    }\n    if (!error && response.statusCode == 200) {\n      req.order = body;\n      next();\n    }\n  });\n};\nexports.gift_qrcode = function(req, res) {\n  var url = 'http://'+req.host+'/gift/listen/'+req.order.id;\n  var QRCode = require('qrcode');\n  QRCode.toDataURL(url,function(err,src){\n    res.render('qrcode_gift',{src:src,order:req.order});\n  });\n};\nexports.download = function(req,res){\n  var Archiver = require('archiver');\n  var zip = Archiver('zip');\n  var fs = require('fs');\n  this.body = zip;\n  zip.on('error', function(err) {console.log(err)});\n  zip.on('close', function() {console.log('压缩程式写入 %d 字节', zip.pointer());});\n  for(var i in giftorders){\n    var order = giftorders[i];\n    var dir = '/mnt/photo/images/gift/qrcode/'+moment(order.time.add).format('YYYY-M')+'/';\n    var file = dir+order.serial+'.png';\n    if (fs.existsSync(file)) { \n      zip.append(fs.createReadStream(file), { name:order.serial+'.png' });\n    }\n  }\n  zip.finalize();\n  \n}\n"],"sourceRoot":"/source/"}